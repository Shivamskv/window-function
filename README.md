# window-function

##Rank the customers based on the total amount they've spent on rentals.
SELECT
    customer_id,
    SUM(amount_spent) AS total_amount_spent
FROM rentals
GROUP BY customer_id
ORDER BY total_amount_spent DESC;


##Calculate the cumulative revenue generated by each film over time.
SELECT
    film_title,
    rental_date,
    SUM(amount_spent) OVER (PARTITION BY film_title ORDER BY rental_date) AS cumulative_revenue
FROM rentals
ORDER BY film_title, rental_date;


##**Determine the average rental duration for each film, considering films with similar lengths.**
SELECT
    film_title,
    AVG(rental_duration) AS average_rental_duration
FROM rentals
GROUP BY film_title;


##Identify the top 3 films in each category based on their rental counts.
WITH RankedFilms AS (
    SELECT
        film_title,
        category,
        COUNT(*) AS rental_count,
        RANK() OVER (PARTITION BY category ORDER BY COUNT(*) DESC) AS rank
    FROM rentals
    JOIN films ON rentals.film_id = films.film_id
    GROUP BY film_title, category
)
SELECT
    film_title,
    category,
    rental_count
FROM RankedFilms
WHERE rank <= 3
ORDER BY category, rank;


##Calculate the difference in rental counts between each customer's total rentals and the average rentals across all customers.
WITH CustomerTotals AS (
    SELECT
        customer_id,
        COUNT(*) AS total_rentals
    FROM rentals
    GROUP BY customer_id
),
AverageRentals AS (
    SELECT
        AVG(total_rentals) AS average_rentals
    FROM CustomerTotals
)
SELECT
    c.customer_id,
    c.total_rentals,
    a.average_rentals,
    (c.total_rentals - a.average_rentals) AS difference
FROM CustomerTotals c
CROSS JOIN AverageRentals a;


##Find the monthly revenue trend for the entire rental store over time.
SELECT 
   DATE_FORMAT(rental_date, '%Y-%m') AS year_month,
    SUM(amount_spent) AS total_revenue
FROM rentals
GROUP BY year_month
ORDER BY year_month;

##Identify the customers whose total spending on rentals falls within the top 20% of all customers.
WITH RankedCustomers AS (
    SELECT
        customer_id,
        total_spending,
        PERCENT_RANK() OVER (ORDER BY total_spending DESC) AS percentile_rank
    FROM (
        SELECT
            customer_id,
            SUM(amount_spent) AS total_spending
        FROM rentals
        GROUP BY customer_id
    ) AS customer_totals
)
SELECT
    customer_id,
    total_spending
FROM RankedCustomers
WHERE percentile_rank <= 0.20
ORDER BY total_spending DESC;


##Calculate the running total of rentals per category, ordered by rental count.
WITH RentalCounts AS (
    SELECT
        category,
        COUNT(*) AS rental_count
    FROM rentals
    GROUP BY category
)
SELECT
    category,
    rental_count,
    SUM(rental_count) OVER (ORDER BY rental_count DESC) AS running_total
FROM RentalCounts
ORDER BY rental_count DESC;


##Find the films that have been rented less than the average rental count for their respective categories.
SELECT
    f.film_title,
    f.category,
    f.rental_count,
    a.avg_rental_count
FROM (
    SELECT
        category,
        film_title,
        COUNT(*) AS rental_count
    FROM rentals
    JOIN films ON rentals.film_id = films.film_id
    GROUP BY category, film_title
) AS f
JOIN (
    SELECT
        category,
        AVG(rental_count) AS avg_rental_count
    FROM (
        SELECT
            category,
            film_title,
            COUNT(*) AS rental_count
        FROM rentals
        JOIN films ON rentals.film_id = films.film_id
        GROUP BY category, film_title
    ) AS FilmCounts
    GROUP BY category
) AS a
ON f.category = a.category
WHERE f.rental_count < a.avg_rental_count;


##Identify the top 5 months with the highest revenue and display the revenue generated in each month.
SELECT
    DATE_FORMAT(rental_date, '%Y-%m') AS year_month,
    SUM(amount_spent) AS total_revenue
FROM rentals
GROUP BY year_month
ORDER BY total_revenue DESC
LIMIT 5;

